Option Explicit

Dim isFirstUserInput As Boolean
Dim runRange48To49 As Boolean
Dim rng As Range

' Variables to hold user inputs from TextBoxes
Private userInput8 As String
Private userInput2 As String
Private userInput3 As String
Private userInput4 As String
Private userInput5 As String
Private userInput23 As String
Private userInput24 As String

' Temporary variable for copy_id
Private copy_id As Integer

' Variable for story_id
Dim story_id As Integer

Private Sub TextBox8_Change()
    ' Capture user input from TextBox8
    userInput8 = TextBox8.Value
End Sub

Private Sub TextBox2_Change()
    ' Capture user input from TextBox2
    userInput2 = TextBox2.Value
End Sub

Private Sub TextBox3_Change()
    ' Capture user input from TextBox3
    userInput3 = TextBox3.Value
End Sub

Private Sub TextBox4_Change()
    ' Capture user input from TextBox4
    userInput4 = TextBox4.Value
End Sub

Private Sub TextBox5_Change()
    ' Capture user input from TextBox5
    userInput5 = TextBox5.Value
End Sub

Private Sub TextBox23_Change()
    ' Capture user input from TextBox23
    userInput23 = TextBox23.Value
End Sub

Private Sub TextBox24_Change()
    ' Capture user input from TextBox24
    userInput24 = TextBox24.Value
End Sub

Private Sub UserForm_Initialize()
    isFirstUserInput = True
    story_id = 39 ' Initialize story_id to 39
End Sub

Sub Loader()
   If isFirstUserInput Then
      isFirstUserInput = False ' Set flag to false after processing first user input
      Set rng = ThisWorkbook.Sheets("Sheet2").Range("A48:J49")
   Else
        If runRange48To49 Then
            Set rng = ThisWorkbook.Sheets("Sheet2").Range("A48:J49")
            runRange48To49 = False
        Else
            Set rng = ThisWorkbook.Sheets("Sheet2").Range("A49:J49")
        End If
    End If
    ProcessRowRange rng
    MsgBox "Work item added.", vbInformation
End Sub

Private Sub CommandButton3_Click()
    If TextBox2.Value = "" Or TextBox3.Value = "" Or TextBox4.Value = "" Or TextBox5.Value = "" Or TextBox8.Value = "" Or TextBox23.Value = "" Or TextBox24.Value = "" Then
        MsgBox "Please enter all fields", vbExclamation
    Else
        ' Call Loader to process the range and paste the data
        Loader
        Call ClearAllInputsExceptTextBox8
    End If
End Sub

Private Sub CommandButton8_Click()
    If MsgBox("Are you sure you want to change TextBox8?", vbYesNo + vbQuestion, "Confirm TextBox8 Change") = vbYes Then
        runRange48To49 = True
        Call ClearAllInputs
    Else
        runRange48To49 = False
    End If
End Sub

Sub ProcessRowRange(rng As Range)
    Dim wsDestination As Worksheet
    Dim destinationRange As Range
    Dim lastRow As Long
    Dim i As Integer
    
    ' Set the destination worksheet (Sheet3) and starting cell
    Set wsDestination = ThisWorkbook.Sheets("Sheet3")
    lastRow = wsDestination.Cells(wsDestination.Rows.Count, "A").End(xlUp).Row ' Adjust to column A
    
    Set destinationRange = wsDestination.Range("A" & lastRow + 1) ' Start pasting from column A
    
    ' Loop through each row and manipulate and paste data based on user inputs
    For i = 1 To rng.Rows.Count
        ' Assign user inputs to variables
        userInput8 = TextBox8.Value
        userInput2 = TextBox2.Value
        userInput3 = TextBox3.Value
        userInput4 = TextBox4.Value
        userInput5 = TextBox5.Value
        userInput23 = TextBox23.Value
        userInput24 = TextBox24.Value
        
        ' Update story_id
        story_id = story_id + 1
        
        ' Update B column with story_id
        destinationRange.Offset(i - 1, 1).Value = story_id
        
        ' Update E column based on runRange48To49
        If runRange48To49 Then
            ' For rows in 48th and 49th, copy value from B column to copy_id and paste in E column
            If i = 2 Then
                copy_id = destinationRange.Offset(i - 2, 1).Value
                destinationRange.Offset(i - 1, 5).Value = "#" & copy_id
            End If
        Else
            ' For other rows, paste the same copy_id value in E column
            destinationRange.Offset(i - 1, 5).Value = "#" & 40 ' Set copy_id to 40 when runRange48To49 is false
        End If
        
        ' Concatenate the values from TextBox8 and TextBox2
        destinationRange.Offset(i - 1, 2).Value = userInput8 & " (" & userInput2 & ")"
        destinationRange.Offset(i - 1, 3).Value = userInput3
        destinationRange.Offset(i - 1, 10).Value = userInput4
        destinationRange.Offset(i - 1, 8).Value = userInput5
        destinationRange.Offset(i - 1, 7).Value = userInput23
        destinationRange.Offset(i - 1, 9).Value = userInput24
    Next i
End Sub

Private Sub ClearAllInputsExceptTextBox8()
    ' Clear all input controls except TextBox8
    TextBox2.Value = ""
    TextBox3.Value = ""
    TextBox4.Value = ""
    TextBox5.Value = ""
    TextBox23.Value = ""
    TextBox24.Value = ""
    TextBox8.Visible = True
    TextBox8.Enabled = False
End Sub

Private Sub ClearAllInputs()
    ' Clear all input controls
    TextBox8.Enabled = True
    TextBox8.Value = ""
    TextBox2.Value = ""
    TextBox3.Value = ""
    TextBox4.Value = ""
    TextBox5.Value = ""
    TextBox23.Value = ""
    TextBox24.Value = ""
End Sub
